---
title: "Single domain models"
author: "Kelley Erickson"
date: "June 3, 2019"
output: html_document
---
<style type="text/css">
.table {

    width: 40%;

}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)



```
# 0. Setup
### Load the data 
```{r, load data, message=FALSE}
#Load demographic data
demog<-read.csv("demography_15_clean.csv", head=T)
library(AICcmodavg)
library(fields)
library(viridis)
library(scales)
my.palette <- viridis(9)
```

This is a csv file where each row is a an individual.

The column names are : 

 * `Obs` : Observation number (each plant should have a different observation number; these were assigned post data entry when we discovered that some of the numbers for individuals were reused between sites
 
 * `Site`: Which site (Big Cypress, Cape Canaveral, Chekika, Forty Pierce, Punta Gorda, Wild Turkey)
 
 * `Plant ID`: The tag number of an individual (each individual in a site has a different number, but numbers were reused across sites)
 
 * `Location`: SeedlingPlot (individual located in a seedling plot) or NA (individual not in seedling plot)
 
 * `Date_i`: The date the census took place for censuses i = 1:7
 * `Status_i`: One of four categories for censuses i=1:7:
    * **alive**: individual was alive when censused
    * **firstdead**: the individual was recorded as dead at this census and was alive at the                      last census 
    * **missing**: the individual was not located at this census
    * **prestudy**: the individual had not been tagged yet 
    * **stilldead**: the individual was already marked dead at a previous census
  * `Death_Cause_i`: One of three categories for censuses i = 1:7:
    * **NA**: for individuals that died, there was no reason to suspect their deaths were due               to management actions
    * **sprayed**: individual death attributed to being sprayed with herbicide (these                       individuals should be excluded)
    * **fire**: individual death attributed to fire (these individuals should be excluded                  from analysis)
 * `Rep_stat_i`: One of 4 categories for censuses  i = 1:7:
    * **NA**: for individuals whose reproductive status is unknown at census i 
    * **female**: for individuals who have produced fruit at any previous census up to an                  including census i 
    * **male**: for individuals who have not produced fruit at any previous census (may have               observed male flowers)
    * **pre-reproductive**: for individuals who have not produced fruit at any previous                   census 
  * `Diam_i`: Diameter (in mm) of individual at census i 
  * `Height_i`: Height (in cm) of individual at census i 
  * `Max_i`: Maximum canopy width in cm of individual at census i 
  * `Min_i`: Minimum canopy width in cm of individual at census i 
  * `Multistem`: For each individual takes on one of two values: 
    * **NA**: individuals that are not multistem
    * **FLAG**: Individuals that are multistem
    
## Stack data 
```{r stack data}
#### Restructure the data in a few different ways: 


Dates <- c(rep(2009, 1512), rep(2010, 1512), rep(2011, 1512), rep(2012, 1512), rep(2013, 1512), rep(2014, 1512))



Death_Cause<-c(demog$Death_Cause_2, demog$Death_Cause_3, demog$Death_Cause_4, demog$Death_Cause_5, demog$Death_Cause_6, demog$Death_Cause_7)

Status<-c(demog$Status_1, demog$Status_2, demog$Status_3, demog$Status_4, demog$Status_5, demog$Status_6, demog$Status_7)

Diams<-cbind(demog$Diam_1, demog$Diam_2, demog$Diam_3, demog$Diam_4, demog$Diam_5, demog$Diam_6, demog$Diam_7) 

row.names(Diams)<-demog$Plant_ID

Heights<-cbind(demog$Height_1, demog$Height_2, demog$Height_3, demog$Height_4, demog$Height_5, demog$Height_6, demog$Height_7)

row.names(Heights)<-demog$Plant_ID

Mins<-cbind(demog$Min_1, demog$Min_2, demog$Min_3, demog$Min_4, demog$Min_5, demog$Min_6, demog$Min_7)

row.names(Mins)<-demog$Plant_ID

Maxs<-cbind(demog$Max_1, demog$Max_2, demog$Max_3, demog$Max_4, demog$Max_5, demog$Max_6, demog$Max_7)

row.names(Maxs)<-demog$Plant_ID

Diams_pooled<-rbind( cbind(Diams[,1], Diams[,2]), cbind(Diams[,2], Diams[,3]), cbind(Diams[, 3], Diams[,4]), cbind(Diams[,4], Diams[,5]), cbind(Diams[,5], Diams[,6]), cbind(Diams[, 6], Diams[, 7]))

Diams_pooled<-data.frame(Diams_pooled[,1], Diams_pooled[,2])

names(Diams_pooled)<-c("t", "t_plus_one")

Sites_pooled<-rep(demog$Site, 6)

ID_pooled<-rep(demog$Plant_ID, 6)

Location<-rep(demog$Location, 6)

Genetic_type_pooled<-rep(0, length(Sites_pooled))

#code which sites are which biotype
for (i in 1:length(Genetic_type_pooled)) { 
	if (Sites_pooled[i]=="Big Cypress") Genetic_type_pooled[i]<-"hybrid"
	else if (Sites_pooled[i]=="Cape Canaveral") Genetic_type_pooled[i]<-"hybrid"
	else if (Sites_pooled[i]=="Chekika") Genetic_type_pooled[i]<-"eastern"
	else if (Sites_pooled[i]=="Fort Pierce") Genetic_type_pooled[i]<-"eastern"
	else if (Sites_pooled[i]=="Punta Gorda") Genetic_type_pooled[i]<-"western"
	else Genetic_type_pooled[i]<-"western"
	
}



Heights_pooled<-rbind( cbind(Heights[,1], Heights[,2]), cbind(Heights[,2], Heights[,3]), cbind(Heights[, 3], Heights[,4]), cbind(Heights[,4], Heights[,5]), cbind(Heights[,5], Heights[,6]), cbind(Heights[, 6], Heights[, 7]))

Heights_pooled<-data.frame(Heights_pooled[,1], Heights_pooled[,2])
names(Heights_pooled)<-c("t", "t_plus_one")



#Finish for maxs and mins 

Maxs_pooled<-rbind(cbind(Maxs[,1], Maxs[,2]), cbind(Maxs[,2], Maxs[,3]), 
	cbind(Maxs[,3], Maxs[,4]), cbind(Maxs[,4], Maxs[,5]), 
	cbind(Maxs[,5], Maxs[,6]), cbind(Maxs[,6], Maxs[,7]))
	
Maxs_pooled<-data.frame(Maxs_pooled[,1], Maxs_pooled[,2])
names(Maxs_pooled)<-c("t", "t_plus_one")



Mins_pooled<-rbind( cbind(Mins[,1], Mins[,2]), cbind(Mins[,2], Mins[,3]), 
	cbind(Mins[,3], Mins[,4]), cbind(Mins[,4], Mins[,5]), 
	cbind(Mins[, 5], Mins[,6]), cbind(Mins[,6], Mins[,7]))
	
Mins_pooled<-data.frame(Mins_pooled[,1], Mins_pooled[,2])
names(Mins_pooled)<-c("t", "t_plus_one")




###Use status matrix to get survival matrix
statmat<-as.matrix(demog[, c(6, 14, 22, 30, 38, 46, 54)])
survmat<-statmat
survmat<- ifelse(survmat=="prestudy"|survmat=="missing"|survmat=="still_dead", NA, survmat)
survmat<- ifelse(survmat =="tagged"|survmat=="alive", 1, 0)

survmat_pooled<-rbind( cbind(survmat[,1], survmat[,2]), cbind(survmat[,2], survmat[,3]), cbind(survmat[, 3], survmat[,4]), cbind(survmat[,4], survmat[,5]), cbind(survmat[,5], survmat[,6]), cbind(survmat[, 6], survmat[, 7]))
names(survmat_pooled)<-c("surv_t", "surv_t_plus_one")


survmat_pooled_bysize<-cbind(Diams_pooled[, 1], survmat_pooled[,2])
names(survmat_pooled_bysize)<-c("size_t", "surv_t_plus_one")



#Use reproduction status matrix to get reproduction matrix
repstatmat<-as.matrix(demog[, c(8, 16, 24, 32, 40, 48, 56)])
repmat<-repstatmat
repmat<- ifelse(repmat =="female", 1, 0)
repmat_pooled<-rbind( cbind(repmat[,1], repmat[,2]), cbind(repmat[,2], repmat[,3]), cbind(repmat[, 3], repmat[,4]), cbind(repmat[,4], repmat[,5]), cbind(repmat[,5], repmat[,6]), cbind(repmat[, 6], repmat[, 7]))


pooled<-cbind(ID_pooled, Sites_pooled, Location, Death_Cause, Genetic_type_pooled, Mins_pooled, Maxs_pooled, Diams_pooled, Heights_pooled, repmat_pooled, survmat_pooled, Dates)
names(pooled)<-c("ID", "Site","Location", "Death_Cause", "Genetic_type", "Min_t", "Min_tplus1", "Max_t", "Max_tplus1", "Diameter_t", "Diameter_tplus1", "Height_t", "Height_tplus1", "Rep_t", "Rep_tplus1", "Surv_t", "Surv_tplus1", "Year")
```

## Investigate relationships among possible state variables 
```{r, investigate state variables}
predictors<-cbind(pooled$Min_t, pooled$Diameter_t, pooled$Height_t, pooled$Max_t)

# What is the correlation amongst the predictor variables? 
correlation<-cor(predictors[, 1:4], use="pairwise.complete.obs")
colnames(correlation)<-c("Min", "Diameter", "Height", "Max")
rownames(correlation)<-c("Min", "Diameter", "Height", "Max")

correlation<-round(correlation, 2)
print(correlation)
#Over the entire dataset, there is the lowest correlation between diameter and height

```

## Exclude outliers 

```{r, exclude outliers}
#Remove individual deaths that were sprayed or fire or grinding
restrict<-subset(pooled, is.na(Death_Cause))

#Remove outliers (very large diameters)
restrict2<-subset(restrict, Diameter_t<800)

#Remove an individual at Big Cypress that went from diameter 1.4 to diameter 108 back to diameter 2.1 
restrict2 <- subset(restrict2, restrict2$ID != 5)

#Questioning why we did this? does this lead to model-eviction? 
#Range of diameter: [0, 800]
0.9*max(restrict2$Diameter_t) #700
#Range of height:  [0, 800]
0.9*max(restrict2$Height_t, na.rm=T) #800
```
# Define some plotting variables: 

```{r setup plotting}
x1seq<-seq(0, 800, length.out=100)
x2seq <- seq(0, 800, length.out=100)


invlogit<-function(x){exp(x)/(1+exp(x))}

# Function to do an image plot of a matrix in the usual orientation, A(1,1) at top left  
matrix.image=function(x,y,A,col=topo.colors(200),...) {
	nx=length(x); ny=length(y); 
	x1=c(1.5*x[1]-0.5*x[2],1.5*x[nx]-0.5*x[nx-1]); 
	y1=c(1.5*y[1]-0.5*y[2],1.5*y[ny]-0.5*y[ny-1]); 
	image.plot(list(x=x,y=y,z=t(A)),xlim=x1,ylim=rev(y1),col=col,bty="u",...);  
}

```

##### Survival 
#--s1: Diameter only
```{r s1}
s1 <- glm(restrict2$Surv_tplus1 ~ restrict2$Diameter_t, family = binomial)
summary(s1)

plot(x1seq, invlogit(s1$coeff[1] + s1$coeff[2]*x1seq), type='l', ylim=c(0,1) , xlab = "Diameter (mm)", ylab="P(Survival)")
points(restrict2$Diameter_t, restrict2$Surv_tplus1)
```
#--s2: Height Only
```{r s2}
s2 <- glm(restrict2$Surv_tplus1 ~ restrict2$Height_t, family = binomial)
summary(s2)

plot(x2seq, invlogit(s2$coeff[1] + s2$coeff[2]*x2seq), type="l", ylim=c(0,1), xlab="Height (cm)", ylab="P(Survival)")
points(restrict2$Height_t, restrict2$Surv_tplus1)
```
#--s3: Diameter + Height
```{r s3}
 s3 <- glm(restrict2$Surv_tplus1 ~ restrict2$Diameter_t + restrict2$Height_t, family = 
                binomial)
  summary(s3)
  
 b0<- s3$coeff[1]
 b1<- s3$coeff[2]
 b2<- s3$coeff[3]


z1<-outer(x1seq, x2seq, function(a,b) (invlogit(b0 + b1*a + b2*b)))

pmat<-persp(x1seq, x2seq, z1, ticktype="detailed",
      theta=-30, zlim=c(0, 1.25), zlab="\n P(Survival)", 
      shade=0.1, nticks=4, xlab="\n Diameter (mm)", 
      ylab="\n Height (cm)",  lwd=1, xaxs="i", 
      main="", cex.main=1)

# from 3D to 2D coordinates
mypoints <- trans3d(restrict2$Diameter_t, restrict2$Height_t, restrict2$Surv_tplus1, pmat=pmat)
# plot in 2D space with pointsize related to distance
points(mypoints, col=4)


par(mar=c(5.1,4.1,4.1,6))
image.plot(x1seq, x2seq, z1, xlab = "Diameter (mm) ", ylab="Height (cm)", col=my.palette, legend.lab = "P(Survival)")
points(restrict2$Diameter_t[restrict2$Surv_tplus1==1], restrict2$Height_t[restrict2$Surv_tplus1==1], pch=19)
points(restrict2$Diameter_t[restrict2$Surv_tplus1==0], restrict2$Height_t[restrict2$Surv_tplus1==0], pch=1)
legend(1.63, 15, pch=c(1,19), cex = 0.8, text.width=0.19, c("Died", "Survived"), xpd=T)
```

#--AIC 
```{r AIC}
aictab(list(s1, s2, s3), modnames= c("s1", "s2", "s3"))
```